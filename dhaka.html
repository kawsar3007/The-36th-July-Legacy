<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DHAKA | Digital Monument of Pride</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        .control-bar { position: sticky; top:0; background: #1E2329; padding: 15px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; border-bottom: 1px solid #FCD535; }
        .map-area { position: relative; width: 1000px; margin: 20px auto; border: 2px solid #333; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; }
        .modal-box { background: #1E2329; padding: 40px; border-radius: 20px; width: 400px; text-align: center; border: 2px solid #FCD535; }
        .payment-pill { background: #000; border: 1px dashed #FCD535; padding: 15px; color: #FCD535; cursor: pointer; font-family: monospace; font-weight: bold; margin: 15px 0; border-radius: 8px; }
    </style>
</head>
<body>

<div class="control-bar">
    <button onclick="location.href='index.html'" style="background:none; color:#fff; border:none; cursor:pointer;"><i class="fas fa-arrow-left"></i> DISTRICT LIST</button>
    <div>
        <input type="number" id="pSearch" placeholder="Plot No (1-1000)" style="padding:10px; border-radius:5px; border:none;">
        <button onclick="findPlot()" style="padding:10px 20px; background:#FCD535; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">SEARCH</button>
    </div>
    <div style="color:#FCD535; font-weight:bold;">DHAKA: ৳36 / Plot</div>
</div>

<div class="map-area">
    <canvas id="plotCanvas"></canvas>
    <div id="legacy-tooltip" style="position:absolute; display:none; background:#ffffca; color:#000; padding:3px 10px; font-size:13px; border:1px solid #000; pointer-events:none;"></div>
</div>

<div id="pModal" class="modal">
    <div class="modal-box">
        <h2 style="color:#FCD535;">RESERVE PLOT #<span id="pNum"></span></h2>
        <p>Step 1: Send <b>৳36</b> to BKASH/NAGAD</p>
        <div class="payment-pill" onclick="copyNum('01756206213')">01756206213 <br>(Click to Copy)</div>
        <p>Step 2: Enter your details</p>
        <input type="text" id="cName" placeholder="Your Name/Brand" style="width:100%; padding:12px; margin-bottom:10px; background:#0B0E11; color:#fff; border:1px solid #444;">
        <input type="number" id="cPhone" placeholder="11 Digit Mobile Number" style="width:100%; padding:12px; margin-bottom:10px; background:#0B0E11; color:#fff; border:1px solid #444;">
        <button onclick="buyNow()" style="width:100%; padding:15px; background:#2ebd85; color:#fff; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">SUBMIT ORDER</button>
        <button onclick="closeModal()" style="background:none; color:#888; border:none; margin-top:15px; cursor:pointer;">Cancel</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://the-5k-elite-legacy-default-rtdb.firebaseio.com" };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database(), dist = "dhaka"; // Change this for other districts

    const cv = document.getElementById('plotCanvas'), ctx = cv.getContext('2d'), bSize = 50, cols = 20;
    cv.width = 1000; cv.height = 50 * bSize;
    let pixels = {};

    db.ref('pixels/' + dist).on('value', s => {
        pixels = s.val() || {};
        ctx.fillStyle = "#fff"; ctx.fillRect(0,0,cv.width,cv.height);
        Object.values(pixels).forEach(p => {
            const id = p.plotID-1, x = (id%cols)*bSize, y = Math.floor(id/cols)*bSize;
            let img = new Image(); img.crossOrigin="anonymous"; img.src=p.imageUrl;
            img.onload = () => ctx.drawImage(img, x, y, bSize, bSize);
        });
    });

    cv.addEventListener('click', (e) => {
        const rect = cv.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (cv.width/rect.width), y = (e.clientY - rect.top) * (cv.height/rect.height);
        const pID = Math.floor(y/bSize)*cols + Math.floor(x/bSize) + 1;
        if(!pixels[pID]) {
            document.getElementById('pNum').innerText = pID;
            document.getElementById('pModal').style.display = 'flex';
        } else if(pixels[pID].link) window.open(pixels[pID].link, '_blank');
    });

    // Tooltip Hover Logic
    cv.addEventListener('mousemove', (e) => {
        const rect = cv.getBoundingClientRect();
        const mouseX = (e.clientX - rect.left) * (cv.width/rect.width);
        const mouseY = (e.clientY - rect.top) * (cv.height/rect.height);
        let found = false;
        Object.values(pixels).forEach(p => {
            const id = p.plotID-1, px = (id%cols)*bSize, py = Math.floor(id/cols)*bSize;
            if(mouseX >= px && mouseX <= px+bSize && mouseY >= py && mouseY <= py+bSize) {
                const tt = document.getElementById('legacy-tooltip');
                tt.style.display = 'block'; tt.style.left = (e.pageX+10)+'px'; tt.style.top = (e.pageY+10)+'px';
                tt.innerText = p.name; cv.style.cursor = 'pointer'; found = true;
            }
        });
        if(!found) { document.getElementById('legacy-tooltip').style.display = 'none'; cv.style.cursor = 'default'; }
    });

    function buyNow() {
        const id = document.getElementById('pNum').innerText, name = document.getElementById('cName').value, phone = document.getElementById('cPhone').value;
        if(!name || phone.length < 11) return alert("Enter correct details!");
        db.ref('orders/' + phone).set({ name, phone, plotID: id, district: dist, time: Date.now() }).then(() => {
            confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            alert("CONGRATULATIONS! Order Submitted."); closeModal();
        });
    }

    function findPlot() {
        const id = document.getElementById('pSearch').value;
        if(id > 0 && id <= 1000) {
            const y = Math.floor((id-1)/cols) * bSize;
            window.scrollTo({ top: y + cv.offsetTop - 100, behavior: 'smooth' });
        }
    }
    function copyNum(n) { navigator.clipboard.writeText(n); alert("Number Copied!"); }
    function closeModal() { document.getElementById('pModal').style.display = 'none'; }
</script>
</body>
</html>
